# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

desktop_arch=('i686' 'x86_64')
# Let me know what ARM architectures are compatible
mobile_arch=()

pkgname=mir-bzr
pkgver=688
_real_ver=0.0.3
pkgrel=1
pkgdesc="Ubuntu's new display server"
arch=(${desktop_arch[@]} ${mobile_arch[@]})
url="https://launchpad.net/mir"
# Server is GPL, client is LGPL
license=('GPL' 'LGPL')
groups=('unitynext')

depends=('boost' `# Maybe gcc4.6`)
# At the moment, Mir does require Mesa's libGL
depends+=('glm' 'mesa-libgl' 'mesa')

if grep -q ${CARCH} <<< ${desktop_arch[@]}; then
  depends+=('libdrm')
fi
if grep -q ${CARCH} <<< ${mobile_arch[@]}; then
  # Currently unpackaged. Presumably, Ubuntu's fork will need to be used
  depends+=('libhybris')
fi

makedepends=('bzr' 'cmake' 'doxygen' 'gflags' 'google-glog' 'graphviz' 'libxkbcommon' 'libxslt' 'protobuf')

# Provide Ubuntu's library names
provides=("libmirprotobuf=${_real_ver}"     # Protocol shared library
          "libmirserver=${_real_ver}"       # Server shared library
          "libmirclient=${_real_ver}"       # Client shared library
          "libmirclient-demos=${_real_ver}" # Example clients
          "mir=${_real_ver}")               # Stable version of Mir
conflicts=('libmirprotobuf'
           'libmirserver'
           'libmirclient'
           'libmirclient-demos'
           'mir')

source=('mir::bzr+http://bazaar.launchpad.net/~mir-team/mir/trunk/'
        '0001_No_documentation.patch')
sha512sums=('SKIP'
            'ef313ff807c6e7134a1f541195fc1cedf969fc22ba2f1220eaa9dc824d3ff934aa88fac1c2a1956f58659d3323b491867cf245c6eba874552eea31c5e3ed2ce7')

pkgver() {
  cd mir
  bzr revno
}

prepare() {
  cd "${srcdir}/mir"

  patch -p0 -i "${srcdir}/0001_No_documentation.patch"
}

build() {
  cd "${srcdir}/mir"

  COMMON_PARAMS=('-DCMAKE_C_COMPILER=gcc'
                 '-DCMAKE_CXX_COMPILER=g++'
                 '-DCMAKE_INSTALL_PREFIX=/usr'
                 '-DMIR_DISABLE_EPOLL_REACTOR=YES'
                 `# Failing to build '-DBUILD_DOXYGEN=YES'`)
  
  if grep -q ${CARCH} <<< ${mobile_arch[@]}; then
    cmake . ${COMMON_PARAMS[@]}         \
            -DBoost_COMPILER=-gcc       \
            -DMIR_PLATFORM=android
  fi

  if grep -q ${CARCH} <<< ${desktop_arch[@]}; then
    cmake . ${COMMON_PARAMS[@]}
  fi

  make
}

check() {
  cd "${srcdir}/mir"
  if grep -q ${CARCH} <<< ${desktop_arch[@]}; then
    GTEST_OUTPUT=xml:./ ctest -j1
  fi
}

package() {
  cd "${srcdir}/mir"
  make DESTDIR="${pkgdir}/" install

  # Install examples
  install -dm755 "${pkgdir}"/usr/share/doc/mir/examples/
  install -m644 examples/demo_client.c               \
                examples/demo_client_accelerated.cpp \
                examples/demo_client_unaccelerated.c \
                examples/README                      \
                examples/graphics.h                  \
                examples/mir_image.h                 \
                examples/graphics_utils.cpp          \
                "${pkgdir}"/usr/share/doc/mir/examples/
}

# vim:set ts=2 sw=2 et:
